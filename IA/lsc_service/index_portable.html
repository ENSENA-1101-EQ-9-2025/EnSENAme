<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EnSEÑAme - LSC Portable (sin backend)</title>
  <link rel="icon" href="../../admin/assets/images/favisena.png" type="image/x-icon" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" />
  <link rel="stylesheet" href="../../admin/assets/fonts/tabler-icons.min.css" />
  <link rel="stylesheet" href="../../admin/assets/css/style.css" />
  <link rel="stylesheet" href="../../admin/assets/css/style-preset.css" />
  <style>
    body { font-family: 'Public Sans', sans-serif; background:#f8f9fa; color:#333; }
    .header { background:linear-gradient(135deg,#22c55e,#16a34a); color:#fff; padding:1rem 0; box-shadow:0 2px 4px rgba(0,0,0,0.08); }
    .container { max-width:1200px; margin:0 auto; padding:0 20px; }
    .row { display:flex; align-items:center; justify-content:space-between; }
    .logo { display:flex; align-items:center; gap:10px; }
    .logo img { height:40px; }
    .logo-text { font-size:1.3rem; font-weight:600; }
    .back-btn { background:rgba(255,255,255,0.2); color:#fff; padding:8px 14px; border-radius:8px; text-decoration:none; display:inline-flex; align-items:center; gap:8px; }
    .back-btn:hover { background:rgba(255,255,255,0.3); }
    .main { max-width:1200px; margin:24px auto; padding:0 20px; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,0.04); overflow:hidden; }
    .card-header { background:#f8fafc; border-bottom:1px solid #e5e7eb; padding:12px 16px; font-weight:600; color:#374151; }
    .card-body { padding:16px; }
    .controls { display:flex; flex-wrap:wrap; gap:10px; }
    .btn { border:none; border-radius:8px; padding:8px 14px; font-weight:500; cursor:pointer; display:inline-flex; align-items:center; gap:8px; }
    .btn-primary { background:#2563eb; color:#fff; }
    .btn-secondary { background:#64748b; color:#fff; }
    .btn-danger { background:#ef4444; color:#fff; }
    .btn-warning { background:#f59e0b; color:#fff; }
    .btn-success { background:#10b981; color:#fff; }
    .btn-outline { background:#fff; color:#374151; border:1px solid #d1d5db; }
    .inline { display:inline-flex; align-items:center; gap:8px; }
    video { width:100%; background:#000; border-radius:8px; }
    .status { display:grid; gap:10px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .badge { display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:600; }
    .badge.ok { background:#d1fae5; color:#065f46; }
    .badge.warn { background:#fef3c7; color:#92400e; }
    .badge.err { background:#fee2e2; color:#991b1b; }
    @media (max-width: 900px) { .grid { grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="header">
    <div class="container">
      <div class="row">
        <div class="logo">
          <img src="../../admin/assets/images/logoensename.PNG" alt="EnSEÑAme" />
          <span class="logo-text">LSC Portable (sin backend)</span>
        </div>
        <div class="inline">
          <a href="../index.html" class="back-btn"><i class="ti ti-brain"></i> Ir a Entrenamiento</a>
          <a href="../../user/index.php" class="back-btn"><i class="ti ti-arrow-left"></i> Volver</a>
        </div>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="card" style="margin-bottom:16px;">
      <div class="card-body" style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
        <span><i class="ti ti-info-circle"></i> Todo corre en tu navegador con TensorFlow.js + KNN. No requiere Python ni servidor.</span>
        <span id="statusBadge" class="badge warn">Cargando modelo...</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-header"><i class="ti ti-video"></i> Cámara</div>
        <div class="card-body">
          <div class="controls" style="margin-bottom:10px;">
            <button id="btnStartCam" class="btn btn-primary"><i class="ti ti-camera"></i> Iniciar cámara</button>
            <button id="btnStopCam" class="btn btn-secondary"><i class="ti ti-player-stop"></i> Detener cámara</button>
          </div>
          <video id="video" autoplay playsinline muted></video>
          <canvas id="canvas" style="display:none;"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><i class="ti ti-language"></i> Traducción</div>
        <div class="card-body">
          <div class="controls" style="margin-bottom:10px;">
            <button id="btnPredict" class="btn btn-warning"><i class="ti ti-bolt"></i> Predecir (1 captura)</button>
            <button id="btnStreamStart" class="btn btn-warning"><i class="ti ti-player-play"></i> Iniciar continuo</button>
            <button id="btnStreamStop" class="btn btn-danger"><i class="ti ti-player-pause"></i> Detener continuo</button>
          </div>
          <div class="controls" style="margin-bottom:10px;">
            <button id="btnLoad" class="btn btn-outline"><i class="ti ti-upload"></i> Cargar modelo</button>
            <button id="btnLoadDefault" class="btn btn-outline" title="Cargar modelo de ejemplo del servidor"><i class="ti ti-cloud-download"></i> Cargar Modelo (Defecto)</button>
          </div>
          <div class="status">
            <div><strong>Estado:</strong> <span id="statusText" class="mono">Inicializando...</span></div>
            <div><strong>Texto:</strong></div>
            <textarea id="textoAcumulado" class="mono" rows="3" style="width:100%;resize:vertical;" readonly></textarea>
            <div class="controls" style="margin:6px 0 10px 0;">
              <button id="btnCopyText" class="btn btn-outline" title="Copiar texto acumulado al portapapeles"><i class="ti ti-copy"></i> Copiar</button>
              <button id="btnClearText" class="btn btn-secondary" title="Borrar texto acumulado"><i class="ti ti-trash"></i> Borrar</button>
            </div>
            <div><strong>Ejemplos totales:</strong> <span id="exCount" class="mono">0</span></div>
            <div><strong>Último error:</strong> <span id="lastErr" class="mono">—</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier@1.2.2"></script>
  <script>
    let video, canvas, ctx;
    let classifier; let mobilenet; let readyModel=false; let readyVideo=false;
    let streamTimer=null; let examplesAdded=0;
    let trainingData = { examples: {}, classNames: [] };

    // Soporte para cargar modelo por defecto desde repo externo (fallback a local)
    const urlParams = new URLSearchParams(location.search);
    const PARAM_MODEL_URL = urlParams.get('modelUrl');
    const REMOTE_CANDIDATES = [
      // Parametro explícito tiene prioridad
      ...(PARAM_MODEL_URL ? [PARAM_MODEL_URL] : []),
      // Rutas comunes en el repo indicado por el usuario
      'https://raw.githubusercontent.com/DanielPedraza023/InterpretacionLSC/main/datos_entrenamiento_senas.json',
      'https://raw.githubusercontent.com/DanielPedraza023/InterpretacionLSC/main/base%20de%20datos/datos_entrenamiento_senas%20(3).json'
    ];
    const LOCAL_DEFAULT_URL = './assets/models/default_training.json';

    const els = {
      badge: document.getElementById('statusBadge'),
      text: document.getElementById('statusText'),
      out: document.getElementById('textoAcumulado'),
      exCount: document.getElementById('exCount'),
      err: document.getElementById('lastErr'),
      
      btnPredict: document.getElementById('btnPredict'),
      btnStreamStart: document.getElementById('btnStreamStart'),
      btnStreamStop: document.getElementById('btnStreamStop'),
      btnLoad: document.getElementById('btnLoad'),
      btnLoadDefault: document.getElementById('btnLoadDefault'),
      btnCopyText: document.getElementById('btnCopyText'),
      btnClearText: document.getElementById('btnClearText')
    };

    function setStatus(msg, cls) {
      els.text.textContent = msg; els.badge.textContent = msg; 
      els.badge.className = 'badge ' + (cls||'ok');
    }

    async function loadModel() {
      try {
        classifier = knnClassifier.create();
        mobilenet = await tf.loadLayersModel('https://storage.googleapis.com/tfjs-models/tfjs/mobilenet_v1_0.25_224/model.json');
        readyModel = true; setStatus('Modelo cargado', 'ok');
      } catch(e) { els.err.textContent = e.toString(); setStatus('Error cargando modelo','err'); }
    }

    async function startCamera() {
      try {
        video = document.getElementById('video');
        canvas = document.getElementById('canvas');
        ctx = canvas.getContext('2d');
        const stream = await navigator.mediaDevices.getUserMedia({ video:{ width:640, height:480 } });
        video.srcObject = stream; await video.play(); readyVideo = true; setStatus('Cámara lista','ok');
      } catch(e) { els.err.textContent = 'No se pudo iniciar la cámara: ' + e.toString(); setStatus('Error cámara','err'); }
    }

    function stopCamera() {
      try { if (video && video.srcObject) { video.srcObject.getTracks().forEach(t=>t.stop()); } readyVideo=false; } catch{}
    }

    function getActivation() {
      const w = video.videoWidth||640, h=video.videoHeight||480;
      canvas.width=224; canvas.height=224;
      ctx.drawImage(video, 0, 0, 224, 224);
      const img = tf.browser.fromPixels(canvas);
      const batched = img.expandDims(0);
      const act = mobilenet.predict(batched);
      img.dispose(); // keep batched for GC
      return act;
    }

    async function addExample() {
      if (!readyModel || !readyVideo) { setStatus('Espera modelo/cámara','warn'); return; }
      const label = (els.label.value||'Seña').trim();
      const activation = getActivation();
      classifier.addExample(activation, label);
      const data = await activation.data();
      if (!trainingData.examples[label]) { trainingData.examples[label]=[]; trainingData.classNames.push(label); }
      trainingData.examples[label].push(Array.from(data));
      examplesAdded++; els.exCount.textContent = String(examplesAdded);
      setStatus(`Ejemplo agregado a "${label}"`,'ok');
    }

    let currentLabel = '';

    function appendText(s){ try { els.out.value += s; els.out.scrollTop = els.out.scrollHeight; } catch{} }

    async function predictOnce() {
      try {
        if (classifier.getNumClasses()===0) { setStatus('Entrena primero','warn'); return; }
        const activation = getActivation();
        const res = await classifier.predictClass(activation);
        const label = res.label || '';
        currentLabel = label;
      } catch(e) { els.err.textContent = e.toString(); }
    }

    function startStreaming() { if (streamTimer) return; streamTimer=setInterval(predictOnce, 1200); }
    function stopStreaming() { if (streamTimer) { clearInterval(streamTimer); streamTimer=null; } }

    // Save/Load local
    function saveLocal() {
      const blob = new Blob([JSON.stringify(trainingData)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download='datos_entrenamiento_senas.json'; document.body.appendChild(a); a.click();
      setTimeout(()=>{document.body.removeChild(a); URL.revokeObjectURL(url);}, 100);
      setStatus('Modelo guardado','ok');
    }

    function loadLocal() {
      const input=document.createElement('input'); input.type='file'; input.accept='.json';
      input.onchange = async (e)=>{
        try {
          const file=e.target.files[0]; if(!file) return; const txt=await file.text();
          const loaded=JSON.parse(txt);
          if(!loaded || !Array.isArray(loaded.classNames) || !loaded.examples) throw new Error('Formato inválido');
          trainingData=loaded; classifier.clearAllClasses();
          for(const cls of trainingData.classNames){
            const list=trainingData.examples[cls]||[]; for(const ex of list){ const t=tf.tensor(ex, [1,1000]); classifier.addExample(t, cls); }
          }
          examplesAdded = trainingData.classNames.reduce((acc,cn)=>acc+(trainingData.examples[cn]?.length||0),0);
          els.exCount.textContent = String(examplesAdded);
          setStatus('Modelo cargado','ok');
        } catch(err){ els.err.textContent = err.toString(); setStatus('Error al cargar','err'); }
      };
      input.click();
    }

    function unique(arr){ return Array.from(new Set(arr)); }
    function normalizeTrainingData(loaded){
      // A) Formato nativo
      if (loaded && Array.isArray(loaded.classNames) && loaded.examples && typeof loaded.examples==='object') {
        return loaded;
      }
      // B) { labels:[], vectors:[ [1000], ... ] }
      if (loaded && Array.isArray(loaded.labels) && Array.isArray(loaded.vectors)){
        const ex = {}; const names = unique(loaded.labels);
        for(let i=0;i<loaded.labels.length;i++){
          const lab = String(loaded.labels[i]||'');
          const vec = loaded.vectors[i]; if(!Array.isArray(vec)) continue;
          (ex[lab] ||= []).push(vec);
        }
        return { classNames: names, examples: ex };
      }
      // C) { classes:[], data: { label: [[1000], ...] } }
      if (loaded && Array.isArray(loaded.classes) && loaded.data && typeof loaded.data==='object'){
        return { classNames: loaded.classes, examples: loaded.data };
      }
      // D) { examples:[ {label, vector} ], classNames? }
      if (loaded && Array.isArray(loaded.examples)){
        const ex={}; const names=[];
        for(const item of loaded.examples){ if(!item) continue; const lab=String(item.label||''); const vec=item.vector; if(!Array.isArray(vec)) continue; (ex[lab] ||= []).push(vec); names.push(lab); }
        return { classNames: unique(loaded.classNames||names), examples: ex };
      }
      throw new Error('Formato inválido');
    }

    async function fetchWithFallback(urls){
      for (const u of urls){
        try{
          const res = await fetch(u, { cache:'no-store' });
          if (res.ok){ return await res.json(); }
        }catch(_){ /* ignorar y continuar */ }
      }
      // Intenta local al final
      const res = await fetch(LOCAL_DEFAULT_URL, { cache:'no-store' });
      if (!res.ok) throw new Error('HTTP '+res.status);
      return await res.json();
    }

    async function loadDefault() {
      try {
        // Intentar repo del usuario y luego fallback local
        const loadedRaw = await fetchWithFallback(REMOTE_CANDIDATES);
        const normalized = normalizeTrainingData(loadedRaw);
        if(!normalized || !Array.isArray(normalized.classNames) || !normalized.examples) throw new Error('Formato inválido');
        trainingData = normalized; classifier.clearAllClasses();
        for(const cls of trainingData.classNames){ const list=trainingData.examples[cls]||[]; for(const ex of list){ const t=tf.tensor(ex,[1,1000]); classifier.addExample(t, cls); } }
        examplesAdded = trainingData.classNames.reduce((acc,cn)=>acc+(trainingData.examples[cn]?.length||0),0);
        els.exCount.textContent = String(examplesAdded);
        const nClases = trainingData.classNames.length;
        if (nClases>0) { setStatus(`Modelo por defecto cargado (${nClases} clase${nClases===1?'':'s'})`,'ok'); }
        else { setStatus('Modelo por defecto cargado (sin ejemplos)','warn'); }
      } catch(err){ els.err.textContent = err.toString(); setStatus('No se pudo cargar modelo por defecto','err'); }
    }

    // Wire UI
    document.getElementById('btnStartCam').addEventListener('click', startCamera);
    document.getElementById('btnStopCam').addEventListener('click', stopCamera);
    els.btnPredict.addEventListener('click', predictOnce);
    els.btnStreamStart.addEventListener('click', startStreaming);
    els.btnStreamStop.addEventListener('click', stopStreaming);
    els.btnLoad.addEventListener('click', loadLocal);
    els.btnLoadDefault.addEventListener('click', loadDefault);
    els.btnClearText.addEventListener('click', ()=>{ try{ els.out.value=''; setStatus('Texto borrado','warn'); }catch{} });
    els.btnCopyText.addEventListener('click', async ()=>{
      try{
        const txt = els.out.value||'';
        if (navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(txt); }
        else { const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }
        setStatus('Texto copiado','ok');
      }catch(e){ els.err.textContent = String(e); setStatus('No se pudo copiar','err'); }
    });

    // Teclas: Enter agrega la letra actual; Espacio agrega un espacio
    document.addEventListener('keydown', (e)=>{
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toUpperCase() : '';
      if (tag==='INPUT' || tag==='TEXTAREA' || (e.target && e.target.isContentEditable)) return;
      if (e.key === 'Enter') { e.preventDefault(); if (currentLabel) appendText(currentLabel); }
      else if (e.key === ' ') { e.preventDefault(); appendText(' '); }
    });

    // Boot
    loadModel();
  </script>
  <script src="../../admin/assets/js/plugins/feather.min.js"></script>
</body>
</html>
